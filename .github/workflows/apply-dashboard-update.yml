name: Apply Dashboard Update

on:
  issues:
    types: [opened, edited, reopened]
  workflow_dispatch:

permissions:
  contents: write
  issues: write

jobs:
  apply:
    if: github.event.issue.state == 'open'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Extract JSON payload from issue body
        shell: bash
        run: |
          python3 <<'PY'
          import json, re, sys, pathlib

          body = """${{ github.event.issue.body }}"""

          # Accept JSON anywhere in the issue body (no fencing required)
          m = re.search(r"(\{[\s\S]*\})", body)
          if not m:
            print("ERROR: No JSON object found in issue body")
            sys.exit(1)

          raw = m.group(1).strip()

          try:
            payload = json.loads(raw)
          except Exception as e:
            print("ERROR: JSON found but failed to parse:", e)
            print("-----RAW START-----")
            print(raw)
            print("-----RAW END-----")
            sys.exit(1)

          pathlib.Path("dashboard_payload.json").write_text(
            json.dumps(payload, indent=2, ensure_ascii=False) + "\n",
            encoding="utf-8"
          )
          print("OK: Payload extracted")
          PY

      - name: Update content.json
        shell: bash
        run: |
          python3 <<'PY'
          import json, pathlib

          payload = json.loads(pathlib.Path("dashboard_payload.json").read_text())
          content_path = pathlib.Path("content.json")

          if content_path.exists():
            content = json.loads(content_path.read_text())
          else:
            content = {}

          content["dashboard"] = payload

          content_path.write_text(
            json.dumps(content, indent=2, ensure_ascii=False) + "\n",
            encoding="utf-8"
          )
          print("OK: content.json updated")
          PY

      - name: Commit changes
        shell: bash
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          if git diff --quiet; then
            echo "No changes to commit"
            exit 0
          fi

          git add content.json dashboard_payload.json
          git commit -m "Apply dashboard update from issue #${{ github.event.issue.number }}"
          git push

      - name: Comment and close issue
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: "âœ… Dashboard update applied successfully."
            })

            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              state: "closed"
            })
